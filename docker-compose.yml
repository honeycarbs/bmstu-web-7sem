version: "3.8"

services:
  backend: &backend
    build:
      context: ./backend
    command: ./app
    ports:
      - 8001:8000
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - neatly-postgres

  backend2:
    <<: *backend
    ports:
      - 8002:8000

  backend3:
    <<: *backend
    ports:
      - 8003:8000


  neatly-postgres:
    image: postgres:alpine
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=neatly
      - POSTGRES_PASSWORD=neatly
      - PGDATA=/pgdata
      - POSTGRES_DB=neatly

  nginx:
    build: ./backend/etc/nginx
    ports:
      - 80:80
    volumes:
      - ./backend/etc/nginx/static:/usr/share/nginx/static
      - ./backend/etc/nginx/conf.d/:/etc/nginx/conf.d/
    restart: always
    links:
      - "backend:backend"
      - "backend2:backend2"
      - "backend3:backend3"
      - "pgadmin:pgadmin"

  pgadmin:
    image: 'dpage/pgadmin4'
    environment:
      - PGADMIN_DEFAULT_EMAIL=user@domain.com
      - PGADMIN_DEFAULT_PASSWORD=SuperSecret
      - traefik.frontend.pgadmin4.rule=Host(`host.example.com`) && PathPrefix(`/pgadmin4`)
    ports:
      - 8090:80
